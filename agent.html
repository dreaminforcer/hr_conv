<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>ElevenLabs Conversational Agent (SDK)</title>
</head>
<body>
  <h1>üéôÔ∏è ElevenLabs SDK Voice Chat</h1>
  <p>Status: <span id="status">Not connected</span></p>
  <button id="startBtn">Start Conversation</button>
  <button id="stopBtn" disabled>Stop Conversation</button>

  <script type="module">
    import { Conversation } from "https://esm.sh/@11labs/client";

    const API_KEY = "sk_390b4884aebd3805236761ad470dda7bc5fe8a57fba0c96e";
    const AGENT_ID = "sKApodJaLWdr6Xo5mslm";

    let conversation;
    const statusEl = document.getElementById("status");
    const startBtn = document.getElementById("startBtn");
    const stopBtn = document.getElementById("stopBtn");

    startBtn.addEventListener("click", async () => {
      startBtn.disabled = true;
      statusEl.textContent = "Connecting...";

      try {
        const signedUrlRes = await fetch(
          `https://api.elevenlabs.io/v1/convai/conversation/get_signed_url?agent_id=${AGENT_ID}`,
          {
            method: "GET",
            headers: {
              "xi-api-key": API_KEY
            }
          }
        );

        const { signed_url } = await signedUrlRes.json();
        console.log("Signed URL:", signed_url);

        const config = {
          agentId: AGENT_ID,
          signedUrl: signed_url,
          dynamicVariables: {
            customer_name: { type: "string", value: "John Doe" },
            account_balance: { type: "number", value: 4200.75 },
            is_premium: { type: "boolean", value: true }
          }
        };

        const callbacks = {
          onConnect: (conversationId) => {
            console.log("‚úÖ Connected to conversation:", conversationId);
            statusEl.textContent = "Connected";
            stopBtn.disabled = false;
          },
          onDisconnect: () => {
            console.log("üîå Disconnected");
            statusEl.textContent = "Disconnected";
            startBtn.disabled = false;
            stopBtn.disabled = true;
          },
          onMessage: (message, role) => {
            console.log(`üí¨ ${role}: ${message}`);
          },
          onError: (error, info) => {
            console.error("‚ùå Error:", error, info);
            statusEl.textContent = "Error";
          },
          onStatusChange: (status) => {
            console.log("‚öôÔ∏è Status changed:", status);
          }
        };

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∏ –∑–∞–ø—É—Å–∫–∞–µ–º —Å–µ—Å—Å–∏—é
        conversation = await Conversation.startSession(config, callbacks);
        await conversation.startRecording();
        console.log("üé§ –ó–∞–ø–∏—Å—å –Ω–∞—á–∞–ª–∞—Å—å");

      } catch (err) {
        console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ —Ä–∞–∑–≥–æ–≤–æ—Ä–∞:", err);
        statusEl.textContent = "Failed to start";
        startBtn.disabled = false;
      }
    });

    stopBtn.addEventListener("click", async () => {
      if (!conversation) return;
      try {
        await conversation.stopRecording();
        console.log("üõë –ó–∞–ø–∏—Å—å –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞");
        await conversation.endSession();
        console.log("üö™ –°–µ—Å—Å–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞");
        conversation = null;
        statusEl.textContent = "Session ended";
      } catch (err) {
        console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ —Ä–∞–∑–≥–æ–≤–æ—Ä–∞:", err);
      }
      stopBtn.disabled = true;
      startBtn.disabled = false;
    });
  </script>
</body>
</html>
