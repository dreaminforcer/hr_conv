<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>ElevenLabs Conversational Agent</title>
</head>
<body>
  <h1>ğŸ™ï¸ Voice Chat with ElevenLabs Agent</h1>
  <p>Status: <span id="status">Disconnected</span></p>
  <button id="toggleBtn">Start Conversation</button>

  <script>
    const AGENT_ID = "sKApodJaLWdr6Xo5mslm"; // â† Ğ’Ğ¡Ğ¢ĞĞ’Ğ¬ ÑĞ²Ğ¾Ğ¹ agent_id
    const API_KEY = "sk_390b4884aebd3805236761ad470dda7bc5fe8a57fba0c96e";   // â† Ğ’Ğ¡Ğ¢ĞĞ’Ğ¬ ÑĞ²Ğ¾Ğ¹ API ĞºĞ»ÑÑ‡

    const statusEl = document.getElementById("status");
    const toggleBtn = document.getElementById("toggleBtn");

    let socket;
    let mediaRecorder;
    let isRecording = false;
    let isConnected = false;

    async function getSignedUrl() {
      console.log("[Step 1] Ğ—Ğ°Ğ¿Ñ€Ğ°ÑˆĞ¸Ğ²Ğ°ĞµĞ¼ signed URL...");
      try {
        const res = await fetch(
          `https://api.elevenlabs.io/v1/convai/conversation/get_signed_url?agent_id=${AGENT_ID}`,
          {
            method: "GET",
            headers: {
              "xi-api-key": API_KEY
            }
          }
        );

        if (!res.ok) {
          console.error("âŒ ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ signed URL:", res.status, await res.text());
          return;
        }

        const data = await res.json();
        console.log("[Step 1] âœ… Signed URL Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½:", data.signed_url);
        return data.signed_url;
      } catch (err) {
        console.error("âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ğ¸ signed URL:", err);
      }
    }

    async function connectToAgent() {
      const signedUrl = await getSignedUrl();
      if (!signedUrl) {
        statusEl.textContent = "ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ğ¸ signed URL";
        return;
      }

      console.log("[Step 2] ĞŸĞ¾Ğ´ĞºĞ»ÑÑ‡Ğ°ĞµĞ¼ÑÑ Ğº WebSocket...");
      socket = new WebSocket(signedUrl);

      socket.onopen = () => {
        console.log("[Step 2] âœ… WebSocket ÑĞ¾ĞµĞ´Ğ¸Ğ½ĞµĞ½Ğ¸Ğµ Ğ¾Ñ‚ĞºÑ€Ñ‹Ñ‚Ğ¾.");
        statusEl.textContent = "Connected. Listening...";
        isConnected = true;
        toggleBtn.textContent = "Stop Conversation";
        startMicrophone();
      };

if (msg.audio) {
  console.log("ğŸ”‰ ĞŸĞ¾Ğ»ÑƒÑ‡ĞµĞ½ raw PCM audio. ĞŸÑ€Ğ¾Ğ±ÑƒĞµĞ¼ Ğ²Ğ¾ÑĞ¿Ñ€Ğ¾Ğ¸Ğ·Ğ²ĞµÑÑ‚Ğ¸...");

  try {
    const audioBuffer = Uint8Array.from(atob(msg.audio), c => c.charCodeAt(0)).buffer;

    const pcmData = new DataView(audioBuffer);
    const samples = new Float32Array(audioBuffer.byteLength / 2);

    // ĞŸÑ€ĞµĞ¾Ğ±Ñ€Ğ°Ğ·ÑƒĞµĞ¼ 16-bit PCM -> Float32
    for (let i = 0; i < samples.length; i++) {
      const s = pcmData.getInt16(i * 2, true); // Little endian
      samples[i] = s / 32768;
    }

    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
    const sampleRate = 16000; // ĞºĞ°Ğº Ğ² metadata
    const audioBufferObj = audioContext.createBuffer(1, samples.length, sampleRate);
    audioBufferObj.getChannelData(0).set(samples);

    const source = audioContext.createBufferSource();
    source.buffer = audioBufferObj;
    source.connect(audioContext.destination);
    source.start();

    console.log("âœ… PCM Ğ´ĞµĞºĞ¾Ğ´Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¾ Ğ¸ Ğ²Ğ¾ÑĞ¿Ñ€Ğ¾Ğ¸Ğ·Ğ²ĞµĞ´ĞµĞ½Ğ¾.");
  } catch (e) {
    console.error("âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ´ĞµĞºĞ¾Ğ´Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğ¸ raw PCM:", e);
  }
};


      socket.onerror = (err) => {
        console.error("âŒ WebSocket Ğ¾ÑˆĞ¸Ğ±ĞºĞ°:", err);
        statusEl.textContent = "WebSocket error.";
      };

      socket.onclose = () => {
        console.warn("âš ï¸ WebSocket ÑĞ¾ĞµĞ´Ğ¸Ğ½ĞµĞ½Ğ¸Ğµ Ğ·Ğ°ĞºÑ€Ñ‹Ñ‚Ğ¾.");
        statusEl.textContent = "Disconnected.";
        isConnected = false;
        toggleBtn.textContent = "Start Conversation";
      };
    }

    async function startMicrophone() {
      console.log("[Step 4] Ğ—Ğ°Ğ¿Ñ€Ğ°ÑˆĞ¸Ğ²Ğ°ĞµĞ¼ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿ Ğº Ğ¼Ğ¸ĞºÑ€Ğ¾Ñ„Ğ¾Ğ½Ñƒ...");
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        console.log("âœ… ĞœĞ¸ĞºÑ€Ğ¾Ñ„Ğ¾Ğ½ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿ĞµĞ½.");

        mediaRecorder = new MediaRecorder(stream, { mimeType: "audio/webm" });
        let audioChunks = [];

        mediaRecorder.ondataavailable = (event) => {
          console.log("ğŸ¤ ĞŸĞ¾Ğ»ÑƒÑ‡ĞµĞ½ Ğ°ÑƒĞ´Ğ¸Ğ¾ Ñ„Ñ€Ğ°Ğ³Ğ¼ĞµĞ½Ñ‚.");
          audioChunks.push(event.data);
        };

        mediaRecorder.onstop = async () => {
          console.log("â¹ï¸ ĞÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° Ğ·Ğ°Ğ¿Ğ¸ÑĞ¸, Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ°ÑƒĞ´Ğ¸Ğ¾ Ğ°Ğ³ĞµĞ½Ñ‚Ñƒ...");

          const audioBlob = new Blob(audioChunks, { type: "audio/webm" });
          audioChunks = [];

          const arrayBuffer = await audioBlob.arrayBuffer();
          const base64Audio = btoa(String.fromCharCode(...new Uint8Array(arrayBuffer)));

          if (socket && socket.readyState === WebSocket.OPEN) {
            console.log("ğŸ“¤ ĞÑ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ° Ğ°ÑƒĞ´Ğ¸Ğ¾ Ğ°Ğ³ĞµĞ½Ñ‚Ñƒ...");
            socket.send(JSON.stringify({ audio: base64Audio }));
          } else {
            console.warn("âš ï¸ ĞĞµĞ²Ğ¾Ğ·Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ°ÑƒĞ´Ğ¸Ğ¾: WebSocket Ğ·Ğ°ĞºÑ€Ñ‹Ñ‚.");
          }

          if (isRecording) {
            console.log("ğŸ” ĞŸÑ€Ğ¾Ğ´Ğ¾Ğ»Ğ¶Ğ°ĞµĞ¼ Ğ·Ğ°Ğ¿Ğ¸ÑÑŒ...");
            mediaRecorder.start();
            setTimeout(() => mediaRecorder.stop(), 2000);
          }
        };

        isRecording = true;
        console.log("â–¶ï¸ Ğ—Ğ°Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ Ğ¿ĞµÑ€Ğ²ÑƒÑ Ğ·Ğ°Ğ¿Ğ¸ÑÑŒ...");
        mediaRecorder.start();
        setTimeout(() => mediaRecorder.stop(), 2000);
      } catch (e) {
        console.error("âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ° Ğº Ğ¼Ğ¸ĞºÑ€Ğ¾Ñ„Ğ¾Ğ½Ñƒ:", e);
        statusEl.textContent = "Microphone error.";
      }
    }

    function stopConversation() {
      console.log("[Step 5] ĞÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° Ñ€Ğ°Ğ·Ğ³Ğ¾Ğ²Ğ¾Ñ€Ğ°...");
      isRecording = false;

      if (mediaRecorder && mediaRecorder.state !== "inactive") {
        console.log("â¹ï¸ ĞÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ Ğ·Ğ°Ğ¿Ğ¸ÑÑŒ.");
        mediaRecorder.stop();
      }

      if (socket && socket.readyState === WebSocket.OPEN) {
        console.log("âŒ Ğ—Ğ°ĞºÑ€Ñ‹Ğ²Ğ°ĞµĞ¼ WebSocket...");
        socket.close();
      }

      statusEl.textContent = "Disconnected.";
      toggleBtn.textContent = "Start Conversation";
      isConnected = false;
    }

    toggleBtn.addEventListener("click", () => {
      if (!isConnected) {
        console.log("ğŸ”„ ĞšĞ½Ğ¾Ğ¿ĞºĞ°: ĞĞ°Ñ‡Ğ°Ñ‚ÑŒ Ñ€Ğ°Ğ·Ğ³Ğ¾Ğ²Ğ¾Ñ€");
        connectToAgent();
      } else {
        console.log("ğŸ”„ ĞšĞ½Ğ¾Ğ¿ĞºĞ°: ĞÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ Ñ€Ğ°Ğ·Ğ³Ğ¾Ğ²Ğ¾Ñ€");
        stopConversation();
      }
    });
  </script>
</body>
</html>
